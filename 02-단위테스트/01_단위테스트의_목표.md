# 01. 단위 테스트의 목표

### 단위 테스트와 코드 설계의 관계

- 코드를 단위 테스트하기 어렵다면, 이는 즉 코드 개선이 반드시 필요하다는 것을 의미한다.
  - 보통 강결합 (tight coupling)에서 저품질이 나타나는데, 여기서 강결합 (tight coupling)은 제품 코드가 서로 충분히 분리되지 않아서 따로 테스트하기 어려움을 뜻한다.
- 하지만 코드 베이스를 단위 테스트할 수 있다고 해도 반드시 코드 품질이 좋은 것을 의미하지는 않는다. 즉, 코드 조각을 단위 테스트 할 수 있다는 것은 좋은 긍정 지표라고 보기 어렵다.

### 단위 테스트란?

- 소프트웨어 프로젝트의 **지속 가능한 성장**을 가능하게 하는 것
- 좋은 단위 테스트 스위트는 개발 속도를 지키면서 침체 단계에 빠지지 않게 한다.
- 테스트가 없는 프로젝트는 처음에는 잘못된 아키텍처 결정이 없고, 걱정할 코드도 없어서 빠르게 진행된다. 하지만 시간이 지날 수록 개발 속도가 느려진다.
  - 소프트웨어 엔트로피 (software entropy) : 개발 속도가 빠르게 감소하는 현상
  - 지속적인 정리와 리팩토링과 같은 적절한 관리를 하지 않고 방치하면 시스템이 더 복잡해지고 무질서해진다.
- 테스트는 안전망 역할을 하며, 대부분의 회귀에 대한 보험을 제공하는 도구이다.
  - 회귀는 코드 수정 후에 기능이 의도한 대로 작동하지 않는 경우를 의미. (소프트웨어 버그 == 회귀)
- 초반에 노력이 필요하지만, 프로젝트 후반에도 잘 성장할 수 있도록 하기 때문에 장기적으로 좋다.
- 코드베이스를 지속적으로 검증하는 테스트 없이는 소프트웨어 개발이 쉽게 확장되지 않는다.
  - 지속성, 확장성을 통해 장기적으로 개발 속도를 유지할 수 있다.

#### 좋은 테스트와 좋지 않은 테스트

- 테스트의 가치와 유지 비용을 고려해야 한다.
- 비용 요소는 다음과 같은 짓다양한 활동에 필요한 시간에 따라 결정된다.
  - 기반 코드를 리팩토링할 때 테스트도 리팩토링하라.
  - 각 코드 변경 시 테스트를 실행하라.
  - 테스트가 잘못된 경고를 발생시킬 경우 처리하라.
  - 기반 코드가 어떻게 동작하는지 이해하려고 할 때는, 테스트를 읽는 데 시간을 투자해라.
- 지속 가능한 프로젝트 성장을 위해서는 고품질 테스트에만 집중해야 한다. 즉, 모든 테스트를 똑같이 작성할 필요는 없다. 가치 있는 테스트만 남긴다.

## 테스트 스위트 품질 측정을 위한 커버리지 지표

### 커버리지 지표

- 가장 널리 사용되는 두 가지 커버리지 지표로 코드 커버리지와 분기 커버리지가 있다.

- 테스트 스위트가 소스 코드를 얼마나 실행하는지를 백분율로 나타낸 것. 일반적으로 커버리지 숫자가 높을수록 더 좋다.

- 테스트 스위트의 품질을 평가하는 데 자주 사용하지만, 효과적으로 측정하는데 사용할 수는 없다.

### 1. 코드 커버리지 (code coverage) (test coverage)

코드 커버리지란, **테스트 스위트가 실행한 코드 라인 수 / 제품 코드베이스의 전체 라인 수**를 의미한다.

```swift
func test_IsStringLong(input: String) -> Bool
{ // 1️⃣ 테스트가 다루는 영역
  if input.count > 5 // 2️⃣ 테스트가 다루는 영역
  	return true // 3️⃣ XXX 테스트가 다루지 않는 영역
  return false // 4️⃣ 테스트가 다루는 영역
} // 5️⃣ 테스트가 다루는 영역
```

위의 코드를 보면, 3️⃣을 제외한 1️⃣, 2️⃣, 4️⃣, 5️⃣가 테스트가 다루는 영역이다. 즉, 테스트가 실행하는 라인 수는 4이고, 코드 커버리지는 4/5 = 0.8 = 80% 이다.



```swift
func test_IsStringLong(input: String) -> Bool
{ // 1️⃣ 테스트가 다루는 영역
  return input.count > 5 // 2️⃣ 테스트가 다루는 영역
} // 3️⃣ 테스트가 다루는 영역
```

위의 코드는 1️⃣, 2️⃣, 3️⃣을 모두 테스트가 다루기 때문에 코드 커버리지는 100%로 증가했다.

- 라인 수만 처리하기 때문에 코드가 작을 수록 테스트 커버리지 지표가 더 좋아진다.
- 코드를 더 작게 해도 테스트 스위트의 가치나 기반 코드베이스의 유지 보수성이 변경되지 않는다.
- 좋은 부정 지표 (단위 테스트를 할 수 없는 코드는 품질이 좋지 않음)이자 나쁜 긍정 지표 (단위 테스트를 할 수 있다고 품질을 보증하지는 않음)이다. 커버리지가 높다고 해서 테스트 스위트의 품질이 높은 것은 아니다.



### 2. 분기 커버리지 (branch coverage)

- 코드 커버리지의 단점을 극복하는 것으로, 코드 커버리지보다 더 정확한 결과를 제공한다.
- 원시 코드 라인 수를 사용하는 대신, if 문과 switch 문과 같은 **제어 구조**에 중점을 둔다. 
- 분기 커버리지란, **테스트 스위트가 수행하는 코드 분기 수 / 제품 코드 베이스의 전체 분기 수**를 의미한다.
- 코드 베이스에서 모든 가능한 분기를 합산하고, 그 중 테스트가 얼마나 많이 실행되는지 확인해야 한다.

```swift
func test_IsStringLong(input: String) -> Bool
{ // 1️⃣ 테스트가 다루는 영역
  return input.count > 5 // 2️⃣ 테스트가 다루는 영역
} // 3️⃣ 테스트가 다루는 영역
```

현재 test_IsStringLong 메서드에는 문자열의 길이가 5자를 초과하는 경우와 그렇지 않은 경우의 2개의 분기가 있다.

테스트는 이런 분기 중 하나에 대해서만 적용되기 때문에 분기 커버리지 지표는 1/2 = 0.5 = 50% 이다.

분기 커버리지 지표는 **분기 개수만** 다루며, 해당 분기를 구현하는 데 얼마나 코드가 필요한지 고려하지 않는다.

<img width="750" alt="스크린샷 2022-07-19 오후 12 20 35" src="https://user-images.githubusercontent.com/95578975/179657456-a79a8447-4655-4b67-a6f0-fdde7abeefbb.png">

테스트는 위의 그림과 같이 2개의 코드 경로 중 1가지만 처리하므로, 분기 커버리지는 50%이다.



### 커버리지 지표에 대한 문제점

- 분기 커버리지 지표로도 테스트 스위트가 충분한지는 알 수 없다. 테스트 스위트의 품질을 결정하는 데 어떤 커버리지 지표도 의존할 수 없는 이유는 다음과 같다.
  - 테스트 대상 시스템의 모든 가능한 결과를 검증한다고 보장할 수 없다.
  - 외부 라이브러리의 코드 경로를 고려할 수 있는 커버리지 지표는 없다.

- 커버리지 지표가 의미 있으려면, 모든 측정 지표를 검증해야 한다. 즉, 커버리지 지표로 테스트가 철저한지 또는 테스트가 충분한지 알 수는 없다.

- 특정 커버리지 숫자를 목표로 하는 것은 좋은 것이 아니다. 그저 커버리지 지표를 지표 그 자체로 보는 것이 좋다.

### 성공적인 테스트 스위트의 특성

- 개발 주기에 통합되어 있음
  - 끊임없이 하면 된다.
- 코드베이스에서 가장 중요한 부분만을 대상으로 함
  - 시스템의 가장 중요한 부분에 단위 테스트 노력을 기울이고, 다른 부분은 간략하게 또는 간접적으로 검증하는 것이 좋다.
  - 대부분의 경우 가장 중요한 부분은 비즈니스 로직 (도메인 모델)이 있는 부분이다. 
  - 다른 부분은 인프라 코드, 데이터베이스나 서드파티 시스템과 같은 외부 서비스 및 종속성, 모든 것을 하나로 묶는 코드의 3가지 범주가 있다.
- 최소한의 유지비로 최대의 가치를 끌어냄
  - 가치 있는 테스트 식별하고, 가치 있는 테스트 작성하기
  - 가치 있는 테스트를 식별하려면, 기준틀 (frame of reference)이 필요하다.
  - 가치 있는 테스트를 작성하려면 코드 설계 기술을 알아야 한다.
  - 작곡가가 되는 데 필요한 노력의 양 >>> 좋은 음악과 나쁜 음악을 구별하는데 필요한 노력인 것처럼, 새로운 테스트를 작성하는 것은 기존 테스트를 시험하는 것보다 더 많은 노력이 든다. 